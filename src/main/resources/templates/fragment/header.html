<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" th:fragment="headFragment">
<head>
    <title></title>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>


    <!--select 박스 검색 가능하게 하기-->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>



    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<!--    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/.min.js"-->
<!--            integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"-->
<!--            crossorigin="anonymous"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
            crossorigin="anonymous"></script>

    <!-- alert 창-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
    <style>
        .login-info{
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .login-info-name{
            display: flex;
            flex-direction: column;
        }
        .login-info-state {
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .login-info-state p{
            font-size: 14px;
            color: #989797;
        }
        .showConnections-header {
            padding: 0;
            background-color: rgb(35, 165, 89);

            /*background-color: rgb(128, 132, 142);*/
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
            width: 7px;
            height: 7px;
            border-radius: 100%;
            margin-right: 5px;
        }
        .showConnections-header2 {
            padding: 0;
            background-color: rgb(128, 132, 142);

            /*background-color: rgb(128, 132, 142);*/
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
            width: 7px;
            height: 7px;
            border-radius: 100%;
            margin-right: 5px;
        }
        .showConnections-header3{
            padding: 0;
            background-color: rgb(18, 250, 87) !important;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
            width: 12px;
            height: 12px;
            border-radius: 100%;
            position: absolute;
            /*right: 12px;*/
            top: 28px;
            left: 38px;
        }
    </style>
</head>
<body>
<header>
    <nav>
        <span>
<!-- data-bs-toggle="dropdown" id="userDrop" aria-expanded="false"  aria-labelledby="userDrop" -->
            <!-- Example single danger button -->
                <div  style="display:inline-block; position: fixed; right: 20px; top: -3px">
                  <button type="button" class="btn" onclick="dropUser()">
                    <img style="height: 35px; width: 35px;border-radius: 30%" th:src="@{${logIn.profilePhoto}}"
                         onerror=this.src='/img/user.jpg'>
                      <div class="showConnections-header3" id="showConnectionsHeader3"></div>
                  </button>
                  <ul class="dropdown-menu" id='userDropbox'  style="right: 0; left: auto">
                    <li class="dropdown-item login-info" id="login-info">
                        <img style="height: 38px; margin-right: 12px; width: 38px;border-radius: 30%" th:src="@{${logIn.profilePhoto}}"
                             onerror=this.src='/img/user.jpg'>
                        <div class="login-info-name">
                            <strong><p th:text="${logIn.name}" style="margin: 0"></p></strong>
                            <div class="login-info-state" id="loginInfoState1">
                                <div class="showConnections-header"></div>
                                <p style="margin: 0">대화 가능</p>
                            </div>
                             <div class="login-info-state" id="loginInfoState2">
                                <div class="showConnections-header2"></div>
                                <p style="margin: 0">자리 비움</p>
                            </div>
                        </div>
                    </li>
                    <li><a class="dropdown-item"  href="/user/userInfo">유저정보</a></li>
                    <li id="logInConversation1"><a class="dropdown-item"  href="#" onclick="conversationAway()">자신을 <strong>자리 비움</strong>(으)로 설정</a></li>
                      <li id="logInConversation2"><a class="dropdown-item"  href="#" onclick="conversationAvailable()">자신을 <strong>활성</strong>(으)로 설정</a></li>

                    <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="#" onclick="withdrawal()">회원탈퇴</a></li>
                    <li><a class="dropdown-item" href="#" onclick="logout()">로그아웃</a></li>
                  </ul>
                </div>
            <!--            <img style="height: 27px; width: 27px;border-radius: 30%" th:src="${logIn.profilePhoto}" onerror=location.href='/img/user.jpg'  onclick="location.href='/user/userInfo'">-->
            <!--            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor"-->
            <!--                 class="bi bi-person-circle"-->
            <!--                 viewBox="0 0 16 16" onclick="location.href='/user/userInfo'">-->
            <!--                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>-->
            <!--                <path fill-rule="evenodd"-->
            <!--                      d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>-->
            <!--            </svg>-->
        </span>
    </nav>
</header>


</body>
<script th:inline="javascript">
    const loginInfo = document.getElementById("login-info");
    const logInConversation1 = document.getElementById("logInConversation1");
    const logInConversation2 = document.getElementById("logInConversation2");
    const loginInfoState1 = document.getElementById("loginInfoState1");
    const loginInfoState2 = document.getElementById("loginInfoState2");
    const showConnectionsHeader3 = document.getElementById("showConnectionsHeader3");
    loginInfo.addEventListener('click', function (event) {
        event.stopPropagation();
    });
    function logout() {
        Swal.fire({
            text: '로그아웃 하시겠습니까?',

            showCancelButton: true, // cancel버튼 보이기. 기본은 원래 없음
            confirmButtonColor: '#3085d6', // confrim 버튼 색깔 지정
            cancelButtonColor: '#d33', // cancel 버튼 색깔 지정
            cancelButtonText: '취소', // cancel 버튼 텍스트 지정
            confirmButtonText: '확인', // confirm 버튼 텍스트 지정

        }).then(result => {
            // 만약 Promise리턴을 받으면,
            if (result.isConfirmed) { // 만약 모달창에서 confirm 버튼을 눌렀다면
                stompClient.unsubscribe('/sub/connect');
                stompClient.disconnect();
                location.href = "/logout";
            }
        });
    }

    function withdrawal() {
            Swal.fire({
                text: '회원탈퇴하시겠습니까?',
                showCancelButton: true,
                confirmButtonText: '확인',
                cancelButtonText: '취소',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/user/withdrawal',
                        method: 'POST',
                        success: function (response) {
                            Swal.fire({
                                text: '회원탈퇴를 완료하였습니다.',
                                confirmButtonColor: '#3085d6', // confrim 버튼 색깔 지정
                                confirmButtonText: '확인', // confirm 버튼 텍스트 지정
                            }).then(() => {
                                location.href = "/logout";
                            });
                        },
                        error: function (xhr, status, error) {
                            console.log(xhr)
                            console.log(status)
                            console.log(error)
                        }
                    })
                }
            });

    }

    function conversationUpdate(){
        $.ajax({
            url:'/user/updateConversation',
            type:'post',
            data:{
                'conversation':logInConversation
            },
            success:function (result){
                let item = JSON.parse(JSON.stringify(result));
                if (item.conversation == 'away') {
                    logInConversation1.textContent ='활성'
                }else{
                    logInConversation2.textContent ='자리 비움'
                }
            }
        });
    }

    function conversationAway() {
        stompClient.send("/pub/connect/conversationAway",
            {},JSON.stringify({
                id:logInId
            }))
        // stompClient.unsubscribe('/sub/connect');
        // stompClient.disconnect();

    }

    function conversationAvailable() {
        stompClient.subscribe('/sub/connect', onMessageReceived);

        // 서버에 username 을 가진 유저가 들어왔다는 것을 알림
        // /pub/chat/enterUser 로 메시지를 보냄
        stompClient.send("/pub/connect/conversationAvailable",
            {},JSON.stringify({
                id:logInId,
                conversation: logInConversation
            }))
    }


    function dropUser(){

        if($("#userDropbox").hasClass("show") === true) {

            $("#userDropbox").attr('class','dropdown-menu');
            console.log("Ssss")

        } else {
            $("#userDropbox").attr('class','dropdown-menu show');
            console.log("rrrrrrrr")
        }
    }


</script>
</html>
